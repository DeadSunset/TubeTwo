# ТЗ: Offline myTube (зафиксированные решения)

## Ключевые решения
- Хранилище данных: **SQLite** (`data/mytube.db`).
- Превью: **файлы WebP** в `data/thumbnails/`.
- Импорт HTML: через **вставку HTML в textarea**.

## Платформа
- Windows + Яндекс Браузер.
- Запуск в 1 клик через `start.bat`.

## Архитектура
- Локальный Node.js-процесс:
  - фронт,
  - API,
  - раздача локальных видео,
  - работа с SQLite.
- Никакой ручной установки СУБД.

## Контентная модель
- **Канал**: папка только с видео.
- **Общак**: видео + подпапки (корень = “Общий канал”, подпапки = каналы).
- **Плейлист**: подпапка внутри канала (вложенность рекурсивная).
- Можно подключать источники с нескольких дисков.

## Стойкость к перезапуску
- Источники сохраняются в SQLite (путь, тип, имя).
- При пропаже диска — видео помечаются недоступными.
- При возврате диска — автоматически становятся доступными.

## Данные видео
Минимальные поля:
- `filePath`, `title`, `channelId`, `playlistPath`, `duration`;
- `type` (`video`/`shorts`), `thumbPath`;
- `sourceUrl`, `sourceType`;
- `viewsOnline`, `likesOnline`, `viewsLocal`, `likedByMe`;
- `lastTimeSec`, `isFinished`, `lastWatchedAt`;
- импортированные и локальные комментарии.

## Shorts
Shorts определяется как:
- `duration <= 60 сек`
- и вертикальный ratio, близкий к 9:16.

## UI разделы
- Main Page (лента 15–20, infinite scroll, фильтры, поиск в текущем наборе).
- Channels (список каналов, удаление из БД, добавление видео).
- Single Channel (парсинг, добавление видео, перескан, фильтр по плейлистам).
- Video (YouTube-like hotkeys/autoplay, прогресс каждые 5 сек, рекомендации).
- Shorts (up/down, autoplay, loop).
- Profile (API key, бэкапы, ошибки, метрики размера данных).

## Импорт URL/HTML
- Контекстное меню видео: импорт из URL/HTML.
- URL: заголовок, просмотры, лайки, комментарии, превью.
- HTML-видео: импорт данных из HTML одной страницы.
- HTML-канала: обязательный ручной матчинг HTML-элементов к локальным видео.
- Автомачтинг по названию только от 90% confidence.
- Повторный импорт перезаписывает импортированные данные, но не локальные комментарии.

## Превью
- Генерация при отсутствии скачанного.
- Рандомный кадр не из первых секунд.
- WebP, ширина 320px, разумное качество.
- Placeholder, пока превью не готово.

## Производительность
- Массовые операции — батчами по 10.
- Всегда прогресс + пауза/продолжить/отмена.
- Ленивая загрузка карточек и превью.

## Ошибки и логи
- Панель ошибок в Profile.
- Логировать: недоступные файлы, скан, превью, импорт, API.
- Для провалов — код + человекочитаемое сообщение + retry + экспорт логов.

## Бэкап/импорт
- Экспорт ZIP: DB + thumbnails + профиль + логи.
- Импорт merge поверх текущих данных.
- Совпадение видео по `filePath`.
- Выбор “более полного” набора данных по весам.
- Локальные комментарии объединяются.

## Done критерии
1. Структура общак/канал/плейлист работает.
2. Перезапуск сохраняет источники и библиотеку.
3. Недоступные видео корректно помечаются и восстанавливаются.
4. Плеер и сохранение прогресса соответствуют требованиям.
5. Shorts UX соответствует требованиям.
6. Комментарии (локальные + импорт + треды) работают.
7. URL/HTML импорт и ручной матчинг для канала работают.
8. Превью генерируются/кешируются без фризов UI.
9. Массовые операции батчами по 10 с управлением.
10. Бэкап ZIP и merge-импорт работают.
11. Панель ошибок с кодами и retry работает.
12. Фильтры и поиск на главной работают.
13. “Понравившееся” соответствует likedByMe.
